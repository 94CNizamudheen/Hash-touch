package com.hashone.hashtouch.printer

import android.content.ComponentName
import android.content.Context
import android.content.Intent
import android.content.ServiceConnection
import android.os.IBinder
import android.util.Log

/**
 * Sunmi AIDL Service Holder
 * Binds to Sunmi printer service if available
 */
object SunmiServiceHolder {

    private const val TAG = "SunmiServiceHolder"
    private const val SERVICE_PACKAGE = "woyou.aidlservice.jiuiv5"
    private const val SERVICE_ACTION = "woyou.aidlservice.jiuiv5.IWoyouService"

    @Volatile
    private var service: ISunmiPrinterService? = null

    @Volatile
    private var isBound = false

    private val connection = object : ServiceConnection {
        override fun onServiceConnected(name: ComponentName?, binder: IBinder?) {
            Log.d(TAG, "Sunmi service connected")
            service = ISunmiPrinterService.Stub.asInterface(binder)
            isBound = true
        }

        override fun onServiceDisconnected(name: ComponentName?) {
            Log.d(TAG, "Sunmi service disconnected")
            service = null
            isBound = false
        }
    }

    fun bind(context: Context): Boolean {
        return try {
            val intent = Intent(SERVICE_ACTION)
            intent.setPackage(SERVICE_PACKAGE)
            context.bindService(intent, connection, Context.BIND_AUTO_CREATE)
        } catch (e: Exception) {
            Log.w(TAG, "Failed to bind Sunmi service: ${e.message}")
            false
        }
    }

    fun getService(context: Context): ISunmiPrinterService? {
        if (service == null && !isBound) {
            bind(context)
            // Wait briefly for binding
            Thread.sleep(500)
        }
        return service
    }

    fun unbind(context: Context) {
        try {
            if (isBound) {
                context.unbindService(connection)
                isBound = false
                service = null
            }
        } catch (e: Exception) {
            Log.w(TAG, "Failed to unbind Sunmi service: ${e.message}")
        }
    }
}

/**
 * Sunmi Printer Service Interface (stub)
 * Real implementation requires Sunmi AIDL files
 */
interface ISunmiPrinterService {
    fun sendRAWData(data: ByteArray, callback: Any?)

    object Stub {
        fun asInterface(binder: IBinder?): ISunmiPrinterService? {
            // This would be generated by AIDL compiler
            // For now, return null (service not available without AIDL)
            return null
        }
    }
}
